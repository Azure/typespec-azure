---
import { FluentLayout } from "../../components/fluent/fluent-layout";
import BaseLayout from "../../layouts/base-layout.astro";
import {
  DashboardFromAzureStorage,
  type CoverageFromAzureStorageOptions,
} from "@typespec/spec-dashboard";
const options: CoverageFromAzureStorageOptions = {
  storageAccountName: "typespec",
  containerName: "coverage",
  manifestContainerName: "manifests-azure",
  emitterNames: [
    "@azure-tools/typespec-python",
    "@azure-tools/typespec-go",
    "@azure-typespec/http-client-csharp",
    "@azure-tools/typespec-ts-rlc",
    "@azure-tools/typespec-ts-modular",
    "@azure-tools/typespec-java",
    "@azure-tools/typespec-cpp",
    "@azure-tools/typespec-rust",
  ],
  modes: ["azure"],
};
---

<BaseLayout>
  <FluentLayout client:only="react">
    <DashboardFromAzureStorage options={options} client:only="react" />
  </FluentLayout>
</BaseLayout>

<script>
  // Client-side script to split Azure table into Data Plane and Management Plane
  function splitAzureTables() {
    console.log('[Azure Dashboard] Attempting to split tables...');
    const tables = document.querySelectorAll('table');
    console.log(`[Azure Dashboard] Found ${tables.length} tables`);
    
    tables.forEach((table, index) => {
      // Skip if already processed
      if (table.hasAttribute('data-split-processed')) {
        console.log(`[Azure Dashboard] Table ${index} already processed, skipping`);
        return;
      }
      
      const headerCell = table.querySelector('th');
      console.log(`[Azure Dashboard] Table ${index} header:`, headerCell?.textContent);
      
      if (!headerCell || !headerCell.textContent?.includes('Azure')) {
        return;
      }
      
      console.log(`[Azure Dashboard] Found Azure table at index ${index}`);
      
      // Check if this is the Azure table by looking at row content
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      console.log(`[Azure Dashboard] Table has ${rows.length} rows`);
      
      const azureRows = rows.filter(row => 
        row.textContent?.includes('Azure_')
      );
      console.log(`[Azure Dashboard] Found ${azureRows.length} Azure rows`);
      
      if (azureRows.length === 0) {
        return;
      }
      
      // Separate data plane and management plane rows
      const dataPlaneRows: HTMLElement[] = [];
      const mgmtPlaneRows: HTMLElement[] = [];
      
      azureRows.forEach((row) => {
        const rowElement = row as HTMLElement;
        if (row.textContent?.includes('Azure_ResourceManager_')) {
          mgmtPlaneRows.push(rowElement);
        } else {
          dataPlaneRows.push(rowElement);
        }
      });
      
      console.log(`[Azure Dashboard] Data plane rows: ${dataPlaneRows.length}, Mgmt plane rows: ${mgmtPlaneRows.length}`);
      
      // If we have both types, split the table
      if (dataPlaneRows.length > 0 && mgmtPlaneRows.length > 0) {
        console.log('[Azure Dashboard] Splitting table...');
        
        // Mark as processed before cloning
        table.setAttribute('data-split-processed', 'true');
        
        // Clone the table for management plane
        const mgmtTable = table.cloneNode(true) as HTMLElement;
        mgmtTable.setAttribute('data-split-processed', 'true');
        
        // Update headers
        const dataHeader = table.querySelector('th');
        const mgmtHeader = mgmtTable.querySelector('th');
        
        if (dataHeader) {
          dataHeader.textContent = dataHeader.textContent?.replace('Azure', 'Azure Data Plane') || '';
        }
        if (mgmtHeader) {
          mgmtHeader.textContent = mgmtHeader.textContent?.replace('Azure', 'Azure Management Plane') || '';
        }
        
        // Clear and repopulate table bodies
        const dataTbody = table.querySelector('tbody');
        const mgmtTbody = mgmtTable.querySelector('tbody');
        
        if (dataTbody && mgmtTbody) {
          // Clear both
          dataTbody.innerHTML = '';
          mgmtTbody.innerHTML = '';
          
          // Add rows to appropriate tables
          dataPlaneRows.forEach(row => dataTbody.appendChild(row.cloneNode(true)));
          mgmtPlaneRows.forEach(row => mgmtTbody.appendChild(row.cloneNode(true)));
          
          // Insert management table after data table's parent div
          const tableParent = table.closest('div');
          if (tableParent && tableParent.parentElement) {
            const mgmtContainer = document.createElement('div');
            mgmtContainer.style.margin = '5px';
            mgmtContainer.appendChild(mgmtTable);
            
            const nextSibling = tableParent.nextSibling;
            if (nextSibling) {
              tableParent.parentElement.insertBefore(mgmtContainer, nextSibling);
            } else {
              tableParent.parentElement.appendChild(mgmtContainer);
            }
            
            console.log('[Azure Dashboard] Successfully split table!');
          }
        }
      } else if (dataPlaneRows.length > 0 || mgmtPlaneRows.length > 0) {
        console.log('[Azure Dashboard] Only one type of rows found, not splitting');
      }
    });
  }
  
  // Run with multiple attempts to catch the React render
  let attemptCount = 0;
  const maxAttempts = 10;
  
  function attemptSplit() {
    attemptCount++;
    console.log(`[Azure Dashboard] Split attempt ${attemptCount}/${maxAttempts}`);
    
    splitAzureTables();
    
    // Keep trying if we haven't found and split the table yet
    if (attemptCount < maxAttempts && !document.querySelector('table[data-split-processed]')) {
      setTimeout(attemptSplit, 500);
    }
  }
  
  // Start attempting after a short delay
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(attemptSplit, 500);
    });
  } else {
    setTimeout(attemptSplit, 500);
  }
  
  // Also observe for dynamic content
  const observer = new MutationObserver((mutations) => {
    const hasNewTables = mutations.some(mutation => 
      Array.from(mutation.addedNodes).some(node => 
        node.nodeType === 1 && (node as Element).querySelector('table')
      )
    );
    
    if (hasNewTables && !document.querySelector('table[data-split-processed]')) {
      console.log('[Azure Dashboard] New tables detected, attempting split');
      setTimeout(splitAzureTables, 300);
    }
  });
  
  observer.observe(document.body, { childList: true, subtree: true });
</script>
