name: TCGC Documentation Update Scheduler

# This workflow triggers GitHub Copilot coding agent via the REST API to maintain TCGC documentation.
# It creates a GitHub issue assigned to copilot-swe-agent[bot], which starts a coding agent session.

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      focus_area:
        description: "Documentation area to focus on"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - user-docs
          - emitter-docs
          - design-docs
          - spector

permissions:
  actions: write
  contents: write
  issues: write
  pull-requests: write

jobs:
  trigger-copilot-agent:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.COPILOT_PAT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build task prompt
        id: build-prompt
        run: |
          FOCUS_AREA="${{ github.event.inputs.focus_area || 'all' }}"
          DATE=$(date +%Y-%m-%d)

          TITLE="[Automated] Update TCGC documentation ($DATE) - Focus: $FOCUS_AREA"
          BODY="Update TCGC documentation (Run date: $DATE). Focus area: $FOCUS_AREA"

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT

      - name: Create issue and assign to Copilot coding agent
        id: create-issue
        run: |
          ISSUE_URL=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues \
            --input - <<< '{
              "title": "${{ steps.build-prompt.outputs.title }}",
              "body": "${{ steps.build-prompt.outputs.body }}",
              "assignees": ["copilot-swe-agent[bot]"],
              "agent_assignment": {
                "target_repo": "${{ github.repository }}",
                "base_branch": "main",
                "custom_instructions": "",
                "custom_agent": "tcgc-doc-updater",
                "model": ""
              }
            }' --jq '.html_url')

          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## TCGC Documentation Update Task Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub Copilot coding agent has been triggered to maintain TCGC documentation." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Focus Area:** ${{ github.event.inputs.focus_area || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Custom Agent:** tcgc-doc-updater" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** ${{ steps.create-issue.outputs.issue_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [agents panel](https://github.com/copilot/agents) for progress." >> $GITHUB_STEP_SUMMARY
