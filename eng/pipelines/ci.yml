# Continuous Integration

trigger:
  branches:
    include:
      - main
      - release/*
  paths:
    exclude:
      - docs/release-notes/*.md
      - packages/website/versioned_docs/version-latest/release-notes/*.md

pr: none

variables:
  - template: templates/variables/globals.yml

jobs:
  # - job: npm_stable
  #   timeoutInMinutes: 90
  #   displayName: Npm publish
  #   pool:
  #     name: azsdk-pool-mms-win-2022-general
  #     vmImage: windows-2022

  #   variables:
  #     TYPESPEC_SKIP_DOCUSAURUS_BUILD: true # Disable docusaurus build

  #   steps:
  #     - checkout: self
  #       submodules: true

  #     - template: ./templates/install.yml
  #       parameters:
  #         nodeVersion: "20.x"
  #     - template: ./templates/build.yml

  #     - script: pnpm run test-official
  #       displayName: Test

  #     - template: ./templates/upload-coverage.yml

  #     - script: |
  #         pnpm config set //registry.npmjs.org/:_authToken=$(azure-sdk-npm-token)
  #         pnpm -r publish --access public --no-git-checks
  #       displayName: Publish packages

  #     - task: AzureCLI@1
  #       displayName: "Publish bundled packages to package storage"
  #       inputs:
  #         azureSubscription: "Azure SDK Engineering System"
  #         scriptLocation: inlineScript
  #         inlineScript: node ./eng/scripts/upload-bundler-packages.js

  #     - task: AzureCLI@1
  #       displayName: "Publish Azure playground"
  #       inputs:
  #         azureSubscription: "Azure SDK Engineering System"
  #         scriptLocation: inlineScript
  #         inlineScript: |
  #           az storage blob upload-batch ^
  #             --destination $web ^
  #             --account-name "cadlplayground" ^
  #             --destination-path cadl-azure/ ^
  #             --source "./packages/typespec-azure-playground-website/dist/" ^
  #             --overwrite

  - job: npm_preview
    timeoutInMinutes: 90
    # dependsOn: npm_stable
    displayName: Npm publish dev version
    # condition: eq(variables['Build.SourceBranch'], 'refs/heads/main') # Only publish -dev on main branch.
    pool:
      name: azsdk-pool-mms-win-2022-general
      vmImage: windows-2022

    variables:
      TYPESPEC_SKIP_DOCUSAURUS_BUILD: true # Disable docusaurus build

    steps:
      - checkout: self
        submodules: true

      - template: ./templates/install.yml
        parameters:
          nodeVersion: "20.x"
      - template: ./templates/build.yml

      - script: node ./core/packages/internal-build-utils/cmd/cli.js bump-version-preview .
        displayName: Bump version to prerelease targets

      - script: pnpm -r publish --access public --no-git-checks --tag next --dry-run
        displayName: Dry run 1

      - script: pnpm --filter='@azure-tools/*' publish --access public --no-git-checks --tag next --dry-run
        displayName: Dry run 2

      - script: pnpm --filter='!./core' publish --access public --no-git-checks --tag next --dry-run
        displayName: Dry run 3

      - script: pnpm --filter='!./core' run lint
        displayName: Dry run 4

      - script: |
          echo "Updating config"
          pnpm config set '//registry.npmjs.org/:_authToken' '${NPM_AUTH_TOKEN}'
          echo "Publishing"
          pnpm -r publish --access public --no-git-checks
        name: Publish
        env:
          NPM_AUTH_TOKEN: $(azure-sdk-npm-token)
