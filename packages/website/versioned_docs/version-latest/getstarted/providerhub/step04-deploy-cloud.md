# 4. Connect and test with RPaas Dogfood

## PREREQUISITES

- Successfully build the TYPESPEC repo (i.e. running `dotnet build`)
- Publish your repo (i.e. publishing the repo to App Service in Visual Studio) and have a URI for the repo. You can use a Microsoft-tenant subscription to publish the repo.
- Merge the Swagger file generated by TYPESPEC into the `RPSaaSDev` branch on https://github.com/Azure/azure-rest-api-specs-pr.
- Set up a Dogfood subscription for RP.

## Notes

- The steps below are similar to the ones specified in the RpaaS Dogfood onboarding doc: https://armwiki.azurewebsites.net/rpaas/onboarddf.html. Please refer to this doc to set up the Dogfood subscription.
- The key difference is that you need to use include the URI of the app as a value of `extension-endpoint-uri` when creating resource types.

## STEPS

## Log in

### I. Using AZ CLI

### 1. Register dogfood cloud environment

```
az cloud register --name Dogfood --endpoint-active-directory-graph-resource-id https://graph.windows-ppe.net/ --endpoint-active-directory-resource-id https://management.core.windows.net/ --endpoint-gallery https://df.gallery.azure-test.net/ --endpoint-resource-manager https://api-dogfood.resources.windows-int.net/ --endpoint-active-directory https://login.windows-ppe.net/
```

### 2. Set the cloud environment to Dogfood

```
az cloud set -n Dogfood
```

### 3. Login

```
az login
```

### 4. Set to targeted subscription

```
az account set -s {subscriptionId}
```

### II. If you use ARM Client to log in, use the command below.

```
ARMClient login dogfood

set SUB=/subscriptions/{subscriptionId}
```

## REGISTER

## 1. Register the Resource Provider (RP)

```
az providerhub provider-registration create `
--provider-namespace "Microsoft.AppSecurity"
--provider-type "Internal" `
--provider-version "2.0" `
--incident-contact-email "lyle@microsoft.com" `
--incident-routing-service "Cloudnet" `
--incident-routing-team "AFD WAF DRI" `
--capabilities effect="Allow" quota-id="CSP_2015-05-01" `
--capabilities effect="Allow" quota-id="CSP_MG_2017-12-01"
--service-tree-infos service-id="{subscriptionId}" `
component-id="{subscriptionId}"
```

## Check results of RP registration

```
az providerhub provider-registration show --provider-namespace "Microsoft.AppSecurity" -o json
```

## 2. Register Resource Type

Replace the endpoint-uri with the uri where your RP is hosted:

`extension-endpoint-uri="https://app-security-waf.azurewebsites.net/" `

### 1) Profiles (Parent resource type)

```
az providerhub resource-type-registration create `
--provider-namespace Microsoft.AppSecurity `
--resource-type Profiles `
--regionality "Regional" `
--routing-type "Default" `
--endpoints api-versions="2022-10-01-preview" `
locations="CentralUS" `
extension-endpoint-uri="https://app-security-waf.azurewebsites.net/" `
extension-categories="ResourceCreationValidate" extension-categories="ResourceCreationBegin" `
extension-categories="ResourceDeletionValidate" extension-categories="ResourceDeletionBegin" `
--swagger-specifications api-versions="2021-08-01-preview" `
swagger-spec-folder-uri="https://github.com/Azure/azure-rest-api-specs-pr/tree/RPSaaSDev/specification/appsecurity/resource-manager/Microsoft.AppSecurity/" `
```

- **Troubleshooting**: If the resource type payload generated by AZ CLI includes an array of disallowed verbs, that might prevent you from creating resources under this resource type. The solution is to update the payload to leave this array of disallowed verbs empty using ARM Client.

### Update Profiles payload to allow action verbs

```
armclient PUT /subscriptions/{subscriptionId}/providers/Microsoft.ProviderHub/providerregistrations/Microsoft.AppSecurity/resourcetyperegistrations/Profiles?api-version=2022-07-01-preview @"C:\RPSaaS\WAFaaSPublishedDogfoodTesting\updateProfileResourceTypeToAllowActionVerbs.json" -verbose
```

### Delete Profiles

If you need to delete the resource type, run the command below:

```
az providerhub resource-type-registration delete --provider-namespace Microsoft.AppSecurity --resource-type Profiles
```

### 2) WebApplicationFirewallPolicies (Subresource type of Profiles)

AZ CLI

```
az providerhub resource-type-registration create `
--provider-namespace Microsoft.AppSecurity `
--resource-type Profiles/WebApplicationFirewallPolicies `
--regionality "Regional" `
--routing-type "Default" `
--endpoints api-versions="2022-10-01-preview" `
locations="CentralUS" `
extension-endpoint-uri="https://app-security-waf.azurewebsites.net/" `
extension-categories="ResourceCreationValidate" extension-categories="ResourceCreationBegin" `
extension-categories="ResourceDeletionValidate" extension-categories="ResourceDeletionBegin" `
--swagger-specifications api-versions="2021-08-01-preview" `
swagger-spec-folder-uri="https://github.com/Azure/azure-rest-api-specs-pr/tree/RPSaaSDev/specification/appsecurity/resource-manager/Microsoft.AppSecurity/" `
```

### Update WAF payload to allow action verbs

```
armclient PUT /subscriptions/{subscriptionId}/providers/Microsoft.ProviderHub/providerregistrations/Microsoft.AppSecurity/resourcetyperegistrations/Profiles/resourcetyperegistrations/WebApplicationFirewallPolicies?api-version=2022-07-01-preview @"C:\RPSaaS\LongRunningOperation\updateWafResourceType.json" -verbose
```

## 3. Role out manifest

```
az providerhub custom-rollout create --provider-namespace Microsoft.AppSecurity --rollout-name DogfoodManifestRollOutOct072022 --canary regions=NorthEurope regions=CentralUS
```

## 4. Check results of resource type registration

### 1) Profiles

```
az providerhub resource-type-registration show --provider-namespace Microsoft.AppSecurity --resource-type Profiles -o json
```

### 2) WebApplicationFirewallPolicies

```
az providerhub resource-type-registration show --provider-namespace Microsoft.AppSecurity --resource-type WebApplicationFirewallPolicies -o json
```

## 5. Register subscription used to create resources

```
armclient POST /subscriptions/{subscriptionId}/providers/Microsoft.AppSecurity/register?api-version=2020-10-01
```

## 6. Sample CRUD Operations

### PUT

### 1) Create Profiles

```
armclient PUT /subscriptions/{subscriptionId}/resourcegroups/lyle/providers/Microsoft.AppSecurity/Profiles/profileoct072022a?api-version=2022-10-01-preview  @"C:\RPSaaS\WAFaaSPublishedDogfoodTesting\profileResourcePayload.json" -verbose
```

### 2) Create WAF

```
armclient PUT /subscriptions/{subscriptionId}/resourcegroups/lyle/providers/Microsoft.AppSecurity/Profiles/profileoct072022a/WebApplicationFirewallPolicies/test082022a?api-version=2022-10-01-preview  @"C:\RPSaaS\WAFaaSPublishedDogfoodTesting\wafResourcePayload.json" -verbose
```

### GET

### 1. Get Profiles

```
armclient GET /subscriptions/{subscriptionId}/resourcegroups/lyle/providers/Microsoft.AppSecurity/Profiles/profileoct072022a?api-version=2022-10-01-preview
```

### 2. Get WAF

```
armclient GET /subscriptions/{subscriptionId}/resourcegroups/lyle/providers/Microsoft.AppSecurity/Profiles/profileoct072022a/WebApplicationFirewallPolicies/test082022a?api-version=2022-10-01-preview
```

## VERIFICATION

Please note that you can perform the steps above without actually having any code thanks to RpaaS's metadata.

In order to verify that the requests _actually hit the TYPESPEC code base_, you can try to hard-code a property in the controller to see if the response body shows the hard-coded value.
